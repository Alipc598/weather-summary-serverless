<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>Weather Summary</title>

    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Lottie -->
    <script src="https://unpkg.com/lottie-web@5.12.2/build/player/lottie.min.js"></script>

    <style>
      html,body { height:100%; margin:0; }
      #map { height:100%; }

      /* Top bar (centered search) */
      .topbar{ position:absolute; inset:12px 12px auto 12px; z-index:1000; pointer-events:none; }
      .topbar-inner{ display:flex; justify-content:center; pointer-events:auto; }
      .search{
        width:min(680px, 90vw);
        padding:10px 14px; border-radius:12px; border:1px solid #ddd; font-size:15px;
        background:rgba(255,255,255,.95); box-shadow:0 6px 24px rgba(0,0,0,.12);
      }

      /* Weather card — LOCKED bottom-left (no dragging) */
      #weather-card{
        position:absolute; bottom:12px; left:12px; z-index:1000;
        background:rgba(255,255,255,.96);
        border-radius:14px; padding:12px 14px; min-width:260px; max-width:min(92vw, 480px);
        box-shadow:0 12px 30px rgba(0,0,0,.18); font:15px/1.45 system-ui, sans-serif;
        border:1px solid #eee;
        cursor:default; user-select:auto; transform:none;
      }

      /* Tight card layout: text left, animation right */
      .card-inner{ display:flex; align-items:center; gap:8px; }
      .metrics{ flex:1 1 auto; min-width:210px; padding-right:4px; }
      .coords{ font-size:12px; color:#666; margin-bottom:6px; }
      .temp{ font-size:32px; font-weight:800; letter-spacing:.2px; }
      .row{ margin-top:4px; }

      /* Animation holder: keep size, trim whitespace around the art */
      .anim-wrap{
        width:132px; height:132px; flex:0 0 132px;
        display:grid; place-items:center;
        margin: -2px -4px -2px 0;
      }
      .anim-wrap > div{ width:100%; height:100%; }

      /* Theme border tints */
      .card--sunny { border-color:#ffe299; }
      .card--rain  { border-color:#b3d4ff; }
      .card--cloudy{ border-color:#d8d8d8; }
      .card--snow  { border-color:#cbe7ff; }
      .card--storm { border-color:#ffc2c2; }

      .leaflet-popup-content { margin:10px 14px; } /* not used now (no popups) */

      @media (max-width:560px){
        .anim-wrap{ width:108px; height:108px; flex-basis:108px; }
        .temp{ font-size:28px; }
      }
    </style>
  </head>
  <body>
    <!-- top search -->
    <div class="topbar">
      <div class="topbar-inner">
        <input id="city-search" class="search" placeholder="Search city... (press Enter to use top result)"/>
      </div>
    </div>

    <!-- LOCKED card with animation INSIDE -->
    <div id="weather-card" role="status" aria-live="polite">
      <div class="card-inner">
        <div class="metrics">
          <div class="coords">—</div>
          <div class="row"><span class="temp">-- °C</span></div>
          <div class="row"><b>Wind:</b> <span class="wind">-- kph</span></div>
          <div class="row"><b>Rain:</b> <span class="rain">-- mm</span></div>
          <div class="row"><b>Summary:</b> <span class="summary">—</span></div>
        </div>
        <div class="anim-wrap"><div id="weather-anim" aria-hidden="true"></div></div>
      </div>
    </div>

    <div id="map"></div>

    <script>
      /* ---------------- Map ---------------- */
      const map = L.map('map').setView([50.081, 14.42], 6);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19, attribution: '&copy; OpenStreetMap'
      }).addTo(map);
      let marker;

      /* ---------------- Card lock (no dragging, no saved pos) ---------------- */
      (function lockCardForever(){
        const card = document.getElementById('weather-card');
        if (!card) return;

        // Clear any persisted position from older builds
        try {
          Object.keys(localStorage || {}).forEach(k => {
            const lk = k.toLowerCase();
            if ((lk.includes('card') && lk.includes('pos')) || (lk.includes('weather') && lk.includes('pos')))
              localStorage.removeItem(k);
          });
        } catch {}

        // Best-effort: disable InteractJS if someone injected it
        try {
          if (window.interact) { try { window.interact(card).unset(); } catch(e) {} }
        } catch {}

        const block = (e)=>{ e.stopImmediatePropagation(); e.preventDefault(); };
        ["mousedown","pointerdown","touchstart","dragstart"].forEach(ev =>
          card.addEventListener(ev, block, true)
        );

        function lock(){
          Object.assign(card.style, {
            top: "", right: "", transform:"none", cursor:"default",
            left: "12px", bottom: "12px"
          });
        }
        if (document.readyState === "loading") {
          document.addEventListener("DOMContentLoaded", lock);
        } else {
          lock();
        }
        window.addEventListener("resize", lock, { passive:true });
      })();

      /* ---------------- Theming & animation ---------------- */
      function tempWord(t){ return t>=28?'Hot':t>=22?'Warm':t>=14?'Mild':t>=5?'Cool':'Cold'; }
      function windWord(w){ return w>=25?'Windy':w>=12?'Breezy':'Calm'; }

      // Use WMO codes to improve condition selection
      const RAIN = new Set([51,53,55,56,57,61,63,65,66,67,80,81,82]);
      const SNOW = new Set([71,73,75,77,85,86]);
      const THUNDER = new Set([95,96,99]);

      function pickCondition({ tempC, windKph, rainMm=0, code=0, thunder=false }) {
        if (THUNDER.has(code) || thunder) return { key:'thunder', theme:'card--storm' };
        if (RAIN.has(code) || (rainMm ?? 0) > 0.01) return { key:'rain', theme:'card--rain' };
        if (SNOW.has(code)) return { key:'snow', theme:'card--snow' };
        if (tempC >= 25 && (rainMm ?? 0) <= 0.01) return { key:'sunny', theme:'card--sunny' };
        return { key:'cloudy', theme:'card--cloudy' };
      }

      let lottieInstance = null;
      async function renderCardAnimation(conditionKey){
        const container = document.getElementById('weather-anim');
        container.innerHTML = '';
        try {
          const res = await fetch(`/animations/${conditionKey}.json`, {cache:'force-cache'});
          if (!res.ok) return;
          const data = await res.json();
          if (lottieInstance) { lottieInstance.destroy(); lottieInstance=null; }
          lottieInstance = lottie.loadAnimation({
            container, renderer:'svg', loop:true, autoplay:true, animationData:data
          });
        } catch {}
      }
      function themeCard(theme){
        const card = document.getElementById('weather-card');
        card.classList.remove('card--sunny','card--rain','card--cloudy','card--snow','card--storm');
        card.classList.add(theme);
      }
      function updateStats({ lat, lon, tempC, windKph, rainMm, summary, theme, conditionKey }){
        const card = document.getElementById('weather-card');
        themeCard(theme);
        card.querySelector('.coords').textContent = `${lat.toFixed(3)}, ${lon.toFixed(3)}`;
        card.querySelector('.temp').textContent   = `${tempC.toFixed(1)} °C`;
        card.querySelector('.wind').textContent   = `${windKph.toFixed(1)} kph`;
        card.querySelector('.rain').textContent   = `${(rainMm||0).toFixed(1)} mm`;
        card.querySelector('.summary').textContent= summary;
        renderCardAnimation(conditionKey);
      }

      /* ---------------- Backend + upstream weather ---------------- */
      async function getWeatherByCity(city){
        const r = await fetch(`/weather-summary?city=${encodeURIComponent(city)}`);
        if (!r.ok) throw new Error('API error');
        return r.json();
      }
      async function getWeatherByLatLon(lat, lon){
        const url = new URL('https://api.open-meteo.com/v1/forecast');
        url.search = new URLSearchParams({
          latitude: lat, longitude: lon,
          current: 'temperature_2m,wind_speed_10m,precipitation,weather_code'
        }).toString();
        const r = await fetch(url);
        if (!r.ok) throw new Error('Upstream error');
        const j = await r.json();
        const cur = j.current || {};
        const temp = Number(cur.temperature_2m ?? NaN);
        const wind = Number(cur.wind_speed_10m ?? 0);
        const rain = Number(cur.precipitation ?? 0);
        const code = Number(cur.weather_code ?? 0);

        const parts = [tempWord(temp)];
        if (THUNDER.has(code)) parts.push('Thunder');
        else if (RAIN.has(code) || rain > 0.01) parts.push('Rain');
        parts.push(windWord(wind));

        return {
          temp_c: temp,
          wind_kph: wind,        // already in km/h for current data
          rain_mm: rain,
          weather_code: code,
          thunder: THUNDER.has(code),
          summary: parts.join(' + ')
        };
      }

      /* ---------------- Glue ---------------- */
      function showWeatherUI({ lat, lon, temp_c, wind_kph, rain_mm=0, weather_code=0, thunder=false, summary }){
        const { key, theme } = pickCondition({ tempC: temp_c, windKph: wind_kph, rainMm: rain_mm, code: weather_code, thunder });
        updateStats({ lat, lon, tempC: temp_c, windKph: wind_kph, rainMm: rain_mm, summary, theme, conditionKey:key });

        if (marker) marker.remove();
        marker = L.marker([lat,lon]).addTo(map); // no popup
      }

      map.on('click', async (e)=>{
        const { lat, lng } = e.latlng;
        try {
          const data = await getWeatherByLatLon(lat, lng);
          showWeatherUI({ lat, lon: lng, ...data });
        } catch (err) { console.error(err); }
      });

      document.getElementById('city-search').addEventListener('keydown', async (e)=>{
        if (e.key !== 'Enter') return;
        const q = e.target.value.trim(); if (!q) return;
        try {
          const gres = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}`, { cache: 'no-store' });
          const [g] = await gres.json();
          let lat = 50.0, lon = 14.4;
          if (g) { lat = +g.lat; lon = +g.lon; map.setView([lat,lon], 11); }
          const data = await getWeatherByCity(q);
          const summary = data.summary ?? `${tempWord(data.temp_c)} + ${windWord(data.wind_kph)}`;
          const latOut = (typeof data.lat === 'number') ? data.lat : lat;
          const lonOut = (typeof data.lon === 'number') ? data.lon : lon;
          showWeatherUI({ lat: latOut, lon: lonOut, temp_c: data.temp_c, wind_kph: data.wind_kph, summary });
        } catch (err) { console.error(err); }
      });

      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(async (pos)=>{
          const lat = pos.coords.latitude, lon = pos.coords.longitude;
          map.setView([lat,lon], 11);
          try { const data = await getWeatherByLatLon(lat, lon); showWeatherUI({ lat, lon, ...data }); } catch {}
        }, ()=>{});
      }
    </script>
  </body>
</html>
