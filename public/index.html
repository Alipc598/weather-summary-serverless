<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>Weather Summary</title>

    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Lottie (for animations) -->
    <script src="https://unpkg.com/lottie-web@5.12.2/build/player/lottie.min.js"></script>

    <style>
      html,body { height:100%; margin:0; }
      #map { height:100%; }

      /* Top bar (centered search + controls) */
      .topbar{
        position:absolute; inset:12px 12px auto 12px; z-index:1000; pointer-events:none;
      }
      .topbar-inner{
        display:flex; gap:12px; justify-content:center; align-items:center;
        pointer-events:auto; flex-wrap:wrap;
      }
      .search{
        width:min(680px, 90vw);
        padding:10px 14px; border-radius:12px; border:1px solid #ddd; font-size:15px;
        background:rgba(255,255,255,.95); box-shadow:0 6px 24px rgba(0,0,0,.12);
      }
      .select-wrap{
        display:flex; align-items:center; gap:8px; padding:8px 12px;
        border-radius:12px; background:rgba(255,255,255,.9); border:1px solid #eee;
        font-size:14px;
      }
      .select-wrap select{ font-size:14px; padding:6px 8px; border-radius:8px; }

      /* Stats card (movable to corners) */
      #weather-card{
        position:absolute; z-index:1000;
        background:rgba(255,255,255,.96);
        border-radius:14px; padding:14px 16px; min-width:280px; max-width:min(92vw, 520px);
        box-shadow:0 12px 30px rgba(0,0,0,.18); font:15px/1.5 system-ui, sans-serif;
        border:1px solid #eee;
      }
      .pos-tr{ top:12px; right:12px; } .pos-tl{ top:12px; left:12px; }
      .pos-br{ bottom:12px; right:12px; } .pos-bl{ bottom:12px; left:12px; }

      /* card layout = text left, animation right */
      .card-inner{ display:flex; align-items:center; gap:16px; }
      .metrics{ flex:1 1 auto; min-width:220px; }
      .anim-wrap{
        width:130px; height:130px; flex:0 0 130px;
        display:grid; place-items:center;
      }
      .anim-wrap > div{ width:100%; height:100%; }

      #weather-card .temp{ font-size:32px; font-weight:800; letter-spacing:.2px; }
      #weather-card .row{ margin-top:4px; }
      #weather-card .coords{ font-size:12px; color:#666; margin-bottom:6px; }

      /* Subtle theme border based on condition */
      .card--sunny { border-color:#ffe299; }
      .card--rain  { border-color:#b3d4ff; }
      .card--cloudy{ border-color:#d8d8d8; }
      .card--snow  { border-color:#cbe7ff; }
      .card--storm { border-color:#ffc2c2; }

      /* Popup a bit wider */
      .leaflet-popup-content { margin:10px 14px; }

      @media (max-width:560px){
        .card-inner{ flex-direction:row; gap:10px; }
        .anim-wrap{ width:96px; height:96px; flex-basis:96px; }
        #weather-card .temp{ font-size:26px; }
      }
    </style>
  </head>
  <body>
    <!-- Top UI bar -->
    <div class="topbar">
      <div class="topbar-inner">
        <input id="city-search" class="search" placeholder="Search city... (press Enter to use top result)"/>
        <div class="select-wrap">
          <span>Card position</span>
          <select id="card-pos">
            <option value="pos-tr" selected>Top right</option>
            <option value="pos-tl">Top left</option>
            <option value="pos-br">Bottom right</option>
            <option value="pos-bl">Bottom left</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Stats card with animation INSIDE -->
    <div id="weather-card" class="pos-tr" role="status" aria-live="polite">
      <div class="card-inner">
        <div class="metrics">
          <div class="coords">—</div>
          <div class="row"><span class="temp">-- °C</span></div>
          <div class="row"><b>Wind:</b> <span class="wind">-- kph</span></div>
          <div class="row"><b>Rain:</b> <span class="rain">-- mm</span></div>
          <div class="row"><b>Summary:</b> <span class="summary">—</span></div>
        </div>
        <div class="anim-wrap">
          <div id="weather-anim" aria-hidden="true"></div>
        </div>
      </div>
    </div>

    <!-- Map -->
    <div id="map"></div>

    <script>
      // -------------------- MAP --------------------
      const map = L.map('map').setView([50.081, 14.42], 6);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19, attribution: '&copy; OpenStreetMap'
      }).addTo(map);
      let marker;

      // -------------------- UI elements --------------------
      const card           = document.getElementById('weather-card');
      const cardPos        = document.getElementById('card-pos');
      const $              = (sel)=>card.querySelector(sel);
      function setCardPos(cls){
        card.classList.remove('pos-tr','pos-tl','pos-br','pos-bl');
        card.classList.add(cls);
      }
      setCardPos('pos-tr');
      cardPos.addEventListener('change', (e)=> setCardPos(e.target.value));

      // -------------------- THEMING / SUMMARY --------------------
      function pickCondition({ tempC, windKph, rainMm, thunder }) {
        if (thunder) return { key:'thunder', theme:'card--storm' };
        if (rainMm > 0.2) return { key:'rain', theme:'card--rain' };
        if (tempC <= 1.5) return { key:'snow', theme:'card--snow' };
        if (windKph >= 25) return { key:'cloudy', theme:'card--cloudy' };
        if (tempC >= 23 && rainMm < 0.2) return { key:'sunny', theme:'card--sunny' };
        return { key:'cloudy', theme:'card--cloudy' };
      }
      function tempWord(t){ return t>=28?'Hot':t>=22?'Warm':t>=14?'Mild':'Cold'; }
      function windWord(w){ return w>=25?'Windy':w>=12?'Breezy':'Calm'; }

      // -------------------- LOTTIE in the CARD --------------------
      let lottieInstance = null;
      async function renderCardAnimation(conditionKey){
        const container = document.getElementById('weather-anim');
        container.innerHTML = '';
        try {
          const res = await fetch(`/animations/${conditionKey}.json`, {cache:'force-cache'});
          if (!res.ok) return; // animation file missing? silently ignore
          const data = await res.json();
          if (lottieInstance) { lottieInstance.destroy(); lottieInstance=null; }
          lottieInstance = lottie.loadAnimation({
            container, renderer:'svg', loop:true, autoplay:true, animationData:data
          });
        } catch {}
      }

      function themeCard(theme){
        card.classList.remove('card--sunny','card--rain','card--cloudy','card--snow','card--storm');
        card.classList.add(theme);
      }

      function updateStats({ lat, lon, tempC, windKph, rainMm, summary, theme, conditionKey }){
        themeCard(theme);
        card.querySelector('.coords').textContent = `${lat.toFixed(3)}, ${lon.toFixed(3)}`;
        card.querySelector('.temp').textContent   = `${tempC.toFixed(1)} °C`;
        card.querySelector('.wind').textContent   = `${windKph.toFixed(1)} kph`;
        card.querySelector('.rain').textContent   = `${(rainMm||0).toFixed(1)} mm`;
        card.querySelector('.summary').textContent= summary;
        renderCardAnimation(conditionKey);
      }

      // -------------------- BACKEND call (your API) --------------------
      async function getWeatherByCity(city){
        const r = await fetch(`/weather-summary?city=${encodeURIComponent(city)}`);
        if (!r.ok) throw new Error('API error');
        return r.json(); // {city,temp_c,wind_kph,summary, lat?, lon?}
      }

      // -------------------- Open-Meteo (precise for coordinates) ------
      async function getWeatherByLatLon(lat, lon){
        const url = new URL('https://api.open-meteo.com/v1/forecast');
        url.search = new URLSearchParams({
          latitude: lat, longitude: lon,
          current: 'temperature_2m,wind_speed_10m,precipitation,weather_code'
        }).toString();
        const r = await fetch(url);
        if (!r.ok) throw new Error('Upstream error');
        const j = await r.json();
        const cur = j.current || {};
        return {
          temp_c: cur.temperature_2m ?? NaN,
          wind_kph: (cur.wind_speed_10m ?? 0),        // already in km/h
          rain_mm: cur.precipitation ?? 0,
          thunder: [95,96,99].includes(cur.weather_code),
          summary: `${tempWord(cur.temperature_2m ?? 0)} + ${windWord((cur.wind_speed_10m ?? 0))}`
        };
      }

      // -------------------- Glue: show on map + card --------------------
      let lastConditionKey = 'cloudy';
      function showWeatherUI({ lat, lon, temp_c, wind_kph, rain_mm=0, thunder=false, summary }){
        const { key, theme } = pickCondition({ tempC: temp_c, windKph: wind_kph, rainMm: rain_mm, thunder });
        lastConditionKey = key;
        updateStats({ lat, lon, tempC: temp_c, windKph: wind_kph, rainMm: rain_mm, summary, theme, conditionKey:key });

        if (marker) marker.remove();
        marker = L.marker([lat,lon]).addTo(map);
        marker.bindPopup(
          `<b>${lat.toFixed(6)},${lon.toFixed(6)}</b><br/>` +
          `${summary}<br/>` +
          `${temp_c.toFixed(1)} °C &nbsp; ${wind_kph.toFixed(1)} kph wind` +
          (rain_mm?` &nbsp; ${rain_mm.toFixed(1)} mm`:``)
        ).openPopup();
      }

      // Map click = precise data
      map.on('click', async (e)=>{
        const { lat, lng } = e.latlng;
        try {
          const data = await getWeatherByLatLon(lat, lng);
          showWeatherUI({ lat, lon: lng, ...data });
        } catch (err) {
          console.error(err);
        }
      });

      // Search (Enter) = use your backend by city name
      document.getElementById('city-search').addEventListener('keydown', async (e)=>{
        if (e.key !== 'Enter') return;
        const q = e.target.value.trim(); if (!q) return;

        // Geocode top result (for centering) with Nominatim
        try {
          const gres = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}`);
          const [g] = await gres.json();
          let lat = 50.0, lon = 14.4;
          if (g) { lat = +g.lat; lon = +g.lon; map.setView([lat,lon], 11); }

          const data = await getWeatherByCity(q);
          const summary = data.summary ?? `${tempWord(data.temp_c)} + ${windWord(data.wind_kph)}`;
          const latOut = (typeof data.lat === 'number') ? data.lat : lat;
          const lonOut = (typeof data.lon === 'number') ? data.lon : lon;
          showWeatherUI({ lat: latOut, lon: lonOut, temp_c: data.temp_c, wind_kph: data.wind_kph, summary });
        } catch (err) {
          console.error(err);
        }
      });

      // First render: try browser geolocation quickly (non-blocking)
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(async (pos)=>{
          const lat = pos.coords.latitude, lon = pos.coords.longitude;
          map.setView([lat,lon], 11);
          try {
            const data = await getWeatherByLatLon(lat, lon);
            showWeatherUI({ lat, lon, ...data });
          } catch {}
        }, ()=>{});
      }
    </script>
  </body>
</html>
